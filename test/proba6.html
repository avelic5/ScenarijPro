<!DOCTYPE html>
<html lang="bs">
<head>
    <meta charset="UTF-8">
    <title>Test grupisiUloge()</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            margin: 20px;
            display: flex;
            gap: 20px;
        }
        #scenarij {
            border: 1px solid #ccc;
            padding: 10px;
            min-height: 350px;
            white-space: pre-wrap;
        }
        #scenarij:focus {
            outline: 2px solid #0077ff;
        }
        button {
            padding: 7px 12px;
            margin-top: 10px;
            cursor: pointer;
        }
        #output {
            border: 1px solid #ccc;
            background: #f7f7f7;
            padding: 10px;
            min-height: 350px;
            white-space: pre;
        }
    </style>
</head>
<body>

<div style="flex: 1;">
    <h2>Scenarij (uredi ovdje)</h2>
    <div id="scenarij" contenteditable="true">
SCENA 1 - PARK

MARKO
Gdje si bio cijeli dan?
Ja te čekam već sat vremena.

IVAN
Ma gužva u gradu.
Nisam mogao prije stići.

(Čuje se sirena.)

MARKO
Dobro, hajde, idemo.

SCENA 2 - KUĆA

ANA
Šta se desilo?

MARKO
Ništa posebno.

IVAN
Gužva, kao i uvijek.
    </div>

    <button id="btnTest">Test grupisiUloge()</button>
</div>

<div style="flex: 1;">
    <h2>Rezultat</h2>
    <pre id="output">// Rezultat će se pojaviti ovdje...</pre>
</div>

<script>
    const divRef = document.getElementById("scenarij");

    // -----------------------------
    // Helper funkcije
    // -----------------------------
    function jePraznaLinija(linija) {
        return linija.trim() === "";
    }

    function jesuLiSpaceIliVelikoSlovo(linija) {
        let t = linija.trim();
        if (t === "") return false;
        return /^[A-ZŠĐČĆŽ ]+$/.test(t);
    }

    function jeNaslovScene(linija) {
        let t = linija.trim();
        return /^SCENA\b/i.test(t);
    }

    function jeLinijaUZagradama(linija) {
        let t = linija.trim();
        return t.startsWith("(") && t.endsWith(")");
    }

    function provjeraPostojiLi(niz, vrijednost) {
        return niz.indexOf(vrijednost) !== -1;
    }

    function jeAkcijskiSegment(linija) {
        if (jePraznaLinija(linija)) return false;
        if (jeLinijaUZagradama(linija)) return false;
        if (jesuLiSpaceIliVelikoSlovo(linija)) return false;
        if (jeNaslovScene(linija)) return true;
        return true;
    }

    // -----------------------------
    // FUNKCIJA grupisiUloge()
    // -----------------------------
    function grupisiUloge() {
        let text = divRef.innerText;
        let recenice = text.split("\n");

        let replike = [];
        let trenutnaScena = "";
        let brojacReplikaPoSceni = {};

        // --- 1) prvi prolaz: skupljanje replika
        for (let i = 0; i < recenice.length; i++) {
            let linija = recenice[i];

            if (jeNaslovScene(linija)) {
                trenutnaScena = linija.trim();
                brojacReplikaPoSceni[trenutnaScena] = brojacReplikaPoSceni[trenutnaScena] || 0;
                continue;
            }

            // Početak replike
            if (jesuLiSpaceIliVelikoSlovo(linija) &&
                i + 1 < recenice.length &&
                !jePraznaLinija(recenice[i + 1]) &&
                !jesuLiSpaceIliVelikoSlovo(recenice[i + 1])) {

                let imeUloge = linija.trim();
                let linijeReplike = [];
                let startIndex = i;
                let lastIndex = i;

                let j = i + 1;
                while (j < recenice.length) {
                    let l2 = recenice[j];

                    if (jeNaslovScene(l2)) break;
                    if (jesuLiSpaceIliVelikoSlovo(l2)) break;
                    if (jePraznaLinija(l2)) { lastIndex = j; break; }

                    if (jeLinijaUZagradama(l2)) {
                        lastIndex = j;
                        j++;
                        continue;
                    }

                    linijeReplike.push(l2);
                    lastIndex = j;
                    j++;
                }

                if (linijeReplike.length > 0) {
                    brojacReplikaPoSceni[trenutnaScena]++;

                    replike.push({
                        scena: trenutnaScena,
                        uloga: imeUloge,
                        linije: linijeReplike,
                        start: startIndex,
                        end: lastIndex,
                        segment: 0
                    });
                }

                i = lastIndex;
            }
        }

        if (replike.length === 0) return [];

        // --- 2) odredi dijalog-segmente
        let sceneImena = [];
        replike.forEach(r => {
            if (!provjeraPostojiLi(sceneImena, r.scena)) sceneImena.push(r.scena);
        });

        for (let scena of sceneImena) {
            let indeksi = [];

            for (let i = 0; i < replike.length; i++) {
                if (replike[i].scena === scena) indeksi.push(i);
            }
            if (indeksi.length === 0) continue;

            let segment = 1;
            replike[indeksi[0]].segment = segment;

            for (let k = 1; k < indeksi.length; k++) {
                let prev = replike[indeksi[k - 1]];
                let cur = replike[indeksi[k]];

                let prekid = false;

                for (let x = prev.end + 1; x < cur.start; x++) {
                    let l = recenice[x];
                    if (jeAkcijskiSegment(l) || jeNaslovScene(l)) {
                        prekid = true;
                        break;
                    }
                }

                if (prekid) segment++;

                replike[indeksi[k]].segment = segment;
            }
        }

        // --- 3) formiranje grupa
        let rezultat = [];

        for (let scena of sceneImena) {
            let indeksi = replike
                .map((r, i) => r.scena === scena ? i : -1)
                .filter(i => i !== -1);

            if (indeksi.length === 0) continue;

            let maxSeg = 0;
            indeksi.forEach(i => {
                if (replike[i].segment > maxSeg) maxSeg = replike[i].segment;
            });

            for (let seg = 1; seg <= maxSeg; seg++) {
                let ulogeSeg = [];

                indeksi.forEach(i => {
                    let r = replike[i];
                    if (r.segment === seg) {
                        if (!provjeraPostojiLi(ulogeSeg, r.uloga)) {
                            ulogeSeg.push(r.uloga);
                        }
                    }
                });

                if (ulogeSeg.length === 0) continue;

                rezultat.push({
                    scena: scena,
                    segment: seg,
                    uloge: ulogeSeg
                });
            }
        }

        return rezultat;
    }

    // -----------------------------
    // UI
    // -----------------------------
    document.getElementById("btnTest").addEventListener("click", () => {
        const result = grupisiUloge();
        document.getElementById("output").textContent =
            JSON.stringify(result, null, 2);
    });
</script>

</body>
</html>
